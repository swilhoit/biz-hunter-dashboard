<!DOCTYPE html>
<html>
<head>
  <title>PDF Analysis Debug</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f3f4f6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1f2937;
    }
    #fileInput {
      margin: 20px 0;
      padding: 10px;
      border: 2px dashed #d1d5db;
      border-radius: 4px;
      width: 100%;
    }
    #results {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    #preview {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .page-preview {
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 10px;
      max-width: 300px;
    }
    .page-preview img {
      max-width: 100%;
      height: auto;
      border: 1px solid #d1d5db;
    }
    .page-preview h3 {
      margin: 10px 0 5px 0;
      font-size: 14px;
      font-weight: bold;
    }
    .processing {
      color: #3b82f6;
    }
    .error {
      color: #ef4444;
    }
    .success {
      color: #10b981;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: #3b82f6;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PDF Analysis Debug Tool</h1>
    <p>This tool helps debug PDF processing and Vision API analysis</p>
    
    <input type="file" id="fileInput" accept=".pdf" />
    
    <div id="progressContainer" style="display: none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div id="progressText"></div>
    </div>
    
    <div id="results"></div>
    <div id="preview"></div>
  </div>

  <script type="module">
    // Import PDF.js
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    
    const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY_HERE'; // Replace with your API key
    
    const resultsDiv = document.getElementById('results');
    const previewDiv = document.getElementById('preview');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    function log(message, className = '') {
      const div = document.createElement('div');
      div.className = className;
      div.textContent = `${new Date().toISOString().substr(11, 8)} - ${message}`;
      resultsDiv.appendChild(div);
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }
    
    function updateProgress(percent, text) {
      progressContainer.style.display = 'block';
      progressFill.style.width = percent + '%';
      progressText.textContent = text;
    }
    
    // Load PDF.js
    async function loadPdfJs() {
      try {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
        document.head.appendChild(script);
        
        await new Promise(resolve => {
          script.onload = resolve;
        });
        
        log('PDF.js loaded successfully', 'success');
        
        // Disable worker to avoid CORS issues
        pdfjsLib.GlobalWorkerOptions.workerSrc = '';
        
      } catch (error) {
        log('Failed to load PDF.js: ' + error.message, 'error');
      }
    }
    
    await loadPdfJs();
    
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
        log('Please select a PDF file', 'error');
        return;
      }
      
      resultsDiv.innerHTML = '';
      previewDiv.innerHTML = '';
      log(`Analyzing: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'processing');
      
      try {
        // Load PDF
        updateProgress(10, 'Loading PDF...');
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({ 
          data: arrayBuffer,
          disableWorker: true,
          useSystemFonts: true
        });
        const pdf = await loadingTask.promise;
        
        log(`PDF loaded. Total pages: ${pdf.numPages}`, 'success');
        
        // Process pages
        const maxPages = Math.min(pdf.numPages, 3); // Process first 3 pages
        const extractedTexts = [];
        
        for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
          const percent = 10 + (pageNum / maxPages * 50);
          updateProgress(percent, `Processing page ${pageNum}/${maxPages}...`);
          
          log(`Processing page ${pageNum}...`);
          
          const page = await pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: 2.0 });
          
          // Create canvas
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          // Render page
          await page.render({
            canvasContext: context,
            viewport: viewport,
            intent: 'print'
          }).promise;
          
          // Add preview
          const previewContainer = document.createElement('div');
          previewContainer.className = 'page-preview';
          previewContainer.innerHTML = `<h3>Page ${pageNum}</h3>`;
          const img = document.createElement('img');
          img.src = canvas.toDataURL('image/png', 0.5);
          previewContainer.appendChild(img);
          previewDiv.appendChild(previewContainer);
          
          // Convert to base64
          const imageData = canvas.toDataURL('image/png');
          const base64Image = imageData.split(',')[1];
          
          log(`Page ${pageNum} rendered. Image size: ${Math.round(base64Image.length / 1024)}KB`);
          
          // Send to Vision API
          updateProgress(percent + 10, `Extracting text from page ${pageNum}...`);
          
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [{
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: 'Extract ALL text from this business document image. Include every detail - business name, prices, revenue, contact info, descriptions. Return the complete extracted text.'
                  },
                  {
                    type: 'image_url',
                    image_url: {
                      url: `data:image/png;base64,${base64Image}`
                    }
                  }
                ]
              }],
              max_tokens: 4000,
              temperature: 0.1
            })
          });
          
          if (!response.ok) {
            throw new Error(`Vision API error: ${response.status}`);
          }
          
          const result = await response.json();
          const extractedText = result.choices[0]?.message?.content;
          
          log(`Page ${pageNum} text extracted: ${extractedText.length} characters`, 'success');
          
          // Show extracted text preview
          const textPreview = document.createElement('div');
          textPreview.style.fontSize = '11px';
          textPreview.style.marginTop = '10px';
          textPreview.style.maxHeight = '200px';
          textPreview.style.overflow = 'auto';
          textPreview.style.background = '#f3f4f6';
          textPreview.style.padding = '5px';
          textPreview.style.borderRadius = '4px';
          textPreview.innerHTML = `<strong>Extracted Text:</strong><br>${extractedText.substring(0, 500)}...`;
          previewContainer.appendChild(textPreview);
          
          extractedTexts.push(extractedText);
        }
        
        // Analyze combined text
        updateProgress(80, 'Analyzing business information...');
        log('\nAnalyzing combined text for business information...', 'processing');
        
        const combinedText = extractedTexts.join('\n\n=== PAGE BREAK ===\n\n');
        log(`Combined text length: ${combinedText.length} characters`);
        
        // Final analysis
        const analysisResponse = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{
              role: 'system',
              content: 'You are analyzing a business for sale document. Extract key information and return as JSON.'
            }, {
              role: 'user',
              content: `Extract business information from this text and return as JSON:
              
              {
                "businessName": "...",
                "askingPrice": 0,
                "annualRevenue": 0,
                "annualProfit": 0,
                "description": "..."
              }
              
              Text:
              ${combinedText}`
            }],
            temperature: 0.1,
            max_tokens: 1000
          })
        });
        
        const analysisResult = await analysisResponse.json();
        const analysis = analysisResult.choices[0]?.message?.content;
        
        updateProgress(100, 'Analysis complete!');
        log('\nFinal Analysis:', 'success');
        log(analysis);
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    });
  </script>
</body>
</html>